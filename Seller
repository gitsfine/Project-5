import java.io.*;
import java.util.ArrayList;
import java.util.Scanner;

public class Seller extends User {

    boolean seller;
    private static String newStoreName;
    private static String newStoreProds;
    private ArrayList<String> sales = new ArrayList<>();
    private ArrayList<Store> stores = new ArrayList<>();


    public Seller(String username, String password, String email, boolean seller) {
        super(username, password, email, seller);
    }

    public void addProduct(String storeName, Product product) {

    }

    public void setSales(ArrayList<String> sales) {
        this.sales = sales;
    }

    public void addSales(String line) { //adds a string representation of a sale in.  called in the process data method.
        sales.add(line);
    }

    public ArrayList<String> getSales() {
        return sales;
    }

    public void addStore(Store store) {
        stores.add(store);
    }

    public Store createStore() {
        //data.txt updates
        ArrayList<String> data = Marketplace.readData();
        String listOfStores = getUsername() + "'s stores: ";
        for (int i = 0; i < stores.size(); i++) {
            if (i == 0) {
                listOfStores += stores.get(i).getStoreName();
            } else {
                listOfStores += ", " + stores.get(i).getStoreName();
            }
        }
        int storesIndex = 0;
        for (int i = 0; i < data.size(); i++) {
            if (data.get(i).equals(listOfStores)) {
                storesIndex = i;
            }
        }

        ArrayList<String> editedData = new ArrayList<>();
        for (int i = 0; i < storesIndex; i++) {
            editedData.add(data.get(i));
        }


        //creating new store
        Scanner scanner = new Scanner(System.in);

        ArrayList<Product> storeProds = new ArrayList<>(); //array list for products

        System.out.println("What is your new stores name?");
        newStoreName = scanner.nextLine();
        //data.txt updates
        String newListOfStores = listOfStores + ", " + newStoreName;
        editedData.add(newListOfStores);
        editedData.add("*NEW STORE*");
        editedData.add(String.format("%s's products:", newStoreName));

        System.out.println("How many products are sold at your store?");
        int numProds = scanner.nextInt();
        scanner.nextLine();

        String[] newProdsNames = new String[numProds];
        String[] newProdsDescrips = new String[numProds];
        int[] newProdsAvail = new int[numProds];
        double[] newProdsPrice = new double[numProds];

        for (int i = 0; i < numProds; i++) {
            //getting info abt each product and putting it in the respective spot in its specific attribute array
            //multiple sections to denote 1st, 2nd, 3rd, 4th ... nth
            if (i ==  0) {
                System.out.println("What is the 1st product's name?");
                newProdsNames[i] = scanner.nextLine();

                System.out.println("What is the 1st product's description?\nFormat: type,milk,syrup,special");
                newProdsDescrips[i] = scanner.nextLine();

                System.out.println("What is the 1st product's quantity available?");
                newProdsAvail[i] = scanner.nextInt();
                scanner.nextLine();

                System.out.println("What is the 1st product's price?");
                newProdsPrice[i] = scanner.nextDouble();
                scanner.nextLine();
            } else if (i == 1) {
                System.out.println("\nWhat is the 2nd product's name?");
                newProdsNames[i] = scanner.nextLine();

                System.out.println("What is the 2nd product's description?\nFormat: type,milk,syrup,special");
                newProdsDescrips[i] = scanner.nextLine();

                System.out.println("What is the 2nd product's quantity available?");
                newProdsAvail[i] = scanner.nextInt();
                scanner.nextLine();

                System.out.println("What is the 2nd product's price?");
                newProdsPrice[i] = scanner.nextDouble();
                scanner.nextLine();
            } else if (i == 2) {
                System.out.println("\nWhat is the 3rd product's name?");
                newProdsNames[i] = scanner.nextLine();

                System.out.println("What is the 3rd product's description?\nFormat: type,milk,syrup,special");
                newProdsDescrips[i] = scanner.nextLine();

                System.out.println("What is the 3rd product's quantity available?");
                newProdsAvail[i] = scanner.nextInt();
                scanner.nextLine();

                System.out.println("What is the 3rd product's price?");
                newProdsPrice[i] = scanner.nextDouble();
                scanner.nextLine();
            } else {
                System.out.printf("\nWhat is the %dth product's name?\n", i);
                newProdsNames[i] = scanner.nextLine();

                System.out.printf("What is the %dth product's description?\nFormat: type,milk,syrup,special\n", i);
                newProdsDescrips[i] = scanner.nextLine();

                System.out.printf("What is the %dth product's quantity available?\n", i);
                newProdsAvail[i] = scanner.nextInt();
                scanner.nextLine();

                System.out.printf("What is the %dth product's price?\n", i);
                newProdsPrice[i] = scanner.nextDouble();
                scanner.nextLine();
            }

            String description = newProdsDescrips[i];
            String type = "";
            String milk = "";
            String syrup = "";
            String special = "";
            for (int j = 0; j < 4; j++) {
                if (j == 3) {
                    special = description;
                } else {
                    if (j == 0) {
                        type = description.substring(0, description.indexOf(","));
                    } else if (j == 1) {
                        milk = description.substring(0, description.indexOf(","));
                    } else if (j == 2) {
                        syrup = description.substring(0, description.indexOf(","));
                    }
                    description = description.substring(description.indexOf(",") + 1);
                }
            }

            Product newProduct = new Product(getUsername(), newStoreName, newProdsNames[i], type, milk, syrup, special, newProdsPrice[i], newProdsAvail[i]);
            storeProds.add(newProduct); //arrayList that holds this store's products
            editedData.add(newProduct.dataTXTRepresentation());
        }

        Store newStore = new Store(getUsername(), newStoreName);
        newStore.setProducts(storeProds);
        stores.add(newStore); //arrayList to hold this seller's stores

        for (int i = (storesIndex + 1); i < data.size(); i++) {
            editedData.add(data.get(i));
        }
        Marketplace.writeData(editedData);

        return newStore;
    }


    public void editStore(Store store, String newStoreName) {

        //updating list of products to reflect new name
        String locator = store.getStoreName() + "'s";
        ArrayList<String> data = Marketplace.readData();
        int storeStartIndex = 0;
        int locatorSize = locator.length();
        for (int i = 0; i < data.size(); i++) {
            String sizedLine = "";

            if (data.get(i).length() >= locatorSize) {
                sizedLine = data.get(i).substring(0, locatorSize);
            }
            if (sizedLine.equals(locator)) {
                storeStartIndex = i;
            }
        }

        //updating data.txt
        String newProductsLine = String.format("%s's products:", newStoreName);
        data.set(storeStartIndex,newProductsLine); //

        //updating list of stores to reflect new name
        String oldStoreName = store.getStoreName();
        String listOfStores = getUsername() + "'s stores: ";
        for (int i = 0; i < stores.size(); i++) {
            if (stores.get(i).getStoreName().equals(oldStoreName)) {
                if (i == 0) {
                    listOfStores += newStoreName;
                } else {
                    listOfStores += ", " + newStoreName;
                }
            } else {
                if (i == 0) {
                    listOfStores += stores.get(i).getStoreName();
                } else {
                    listOfStores += ", " + stores.get(i).getStoreName();
                }
            }
        }

        String email = getEmail();
        int emailIndex = 0;
        for (int i = 0; i < data.size(); i++) {
            if (data.get(i).equals(email)) {
                emailIndex = i;
            }
        }

        //updating data.txt
        data.set((emailIndex + 2), listOfStores);
        Marketplace.writeData(data);

        //making the change
        for (int i = 0; i < Marketplace.storeArrayList.size(); i++) {
            if (Marketplace.storeArrayList.get(i).getStoreName().equals(store.getStoreName())) {
                Marketplace.storeArrayList.get(i).setStoreName(newStoreName);
            }
        }
        for (int i = 0; i < getStores().size(); i++) {
            if (getStores().get(i).getStoreName().equals(store.getStoreName())) {
                getStores().get(i).setStoreName(newStoreName);
            }
        }
        store.setStoreName(newStoreName);
        System.out.printf("Done! Your new store name is: %s\n", store.getStoreName());
    }

    public void deleteStore(Store store) {
        ArrayList<String> data = Marketplace.readData();
        int startIndex = 0; //index of the first line to be removed
        int endIndex = 0; //index of the first line to be preserved

        //locating indexes
        String storeLine = String.format("%s's products:", store.getStoreName());
        for (int i = 0; i < data.size(); i++) {
            if (data.get(i).equals(storeLine)) {
                startIndex = (i - 1);
            }

            if ((startIndex != 0) && ((data.get(i).equals("*NEW STORE*")) || (data.get(i).equals("*NEW USER*")))) {
                endIndex = i;
                break;
            }
        }

        //updating list of stores to reflect new name
        String oldStoreName = store.getStoreName();
        String listOfStores = getUsername() + "'s stores: ";
        for (int i = 0; i < stores.size(); i++) {
            if (stores.get(i).getStoreName().equals(oldStoreName)) {
                continue;
            } else {
                if (i == 0) {
                    listOfStores += stores.get(i).getStoreName();
                } else {
                    listOfStores += ", " + stores.get(i).getStoreName();
                }
            }
        }

        String email = getEmail();
        int emailIndex = 0;
        for (int i = 0; i < data.size(); i++) {
            if (data.get(i).equals(email)) {
                emailIndex = i;
            }
        }

        //updating data.txt
        data.set((emailIndex + 2), listOfStores);

        //removing from data.txt
        for (int i = 0; i < (endIndex - startIndex); i++) {
            data.remove(startIndex);
        }
        Marketplace.writeData(data);

        //making the change
        for (int i = 0; i < Marketplace.storeArrayList.size(); i++) {
            if (Marketplace.storeArrayList.get(i).getStoreName().equals(store.getStoreName())) {
                Marketplace.storeArrayList.remove(i);
            }
        }
        for (int i = 0; i < getStores().size(); i++) {
            if (getStores().get(i).getStoreName().equals(store.getStoreName())) {
                getStores().remove(i);
            }
        }
        System.out.printf("Done! %s no longer exists.\n", store.getStoreName());
    }
    public void listStores() {
        for (int i = 0; i < stores.size(); i++) {
            System.out.printf("%d. %s\n", (i + 1), stores.get(i).getStoreName());
        }
    }

    public void statistics() { // statistics method
        System.out.printf("Here are your sales!\n\n");
        for (int i = 0; i < sales.size(); i++) {
            System.out.printf("%s", sales.get(i));
        }

        //needs sorting options and the ability to filter by stores
    }
    public ArrayList<Store> getStores() {
        return stores;
    }

    public void exportFile() {
        ArrayList<String> data = Marketplace.readData();
        String listOfStores = getUsername() + "'s stores: ";
        for (int i = 0; i < stores.size(); i++) {
            if (i == 0) {
                listOfStores += stores.get(i).getStoreName();
            } else {
                listOfStores += ", " + stores.get(i).getStoreName();
            }
        }

        int storesIndex = 0;
        for (int i = 0; i < data.size(); i++) {
            if (data.get(i).equals(listOfStores)) {
                storesIndex = i;
            }
        }

        try {
            System.out.printf("What would you like your new file to be called?\n");
            String newFileName = Marketplace.scanner.nextLine();

            File file = new File(newFileName);
            file.createNewFile();
            FileWriter writer = new FileWriter(file);

            for (int i = (storesIndex + 1); i < data.size(); i++) {
                if (data.get(i).charAt(0) == 42) {
                    if (data.get(i).equals("*NEW STORE*")) {
                        String line = String.format("%s\n", data.get(i));
                        writer.write(line);
                    } else {
                        break;
                    }
                } else {
                    String line = String.format("%s\n", data.get(i));
                    writer.write(line);
                }
            }

            writer.close();
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    public void importFile() {
        //data.txt updates #1 locating index
        ArrayList<String> data = Marketplace.readData();
        String listOfStores = getUsername() + "'s stores: ";
        for (int i = 0; i < stores.size(); i++) {
            if (i == 0) {
                listOfStores += stores.get(i).getStoreName();
            } else {
                listOfStores += ", " + stores.get(i).getStoreName();
            }
        }
        int storesIndex = 0;
        for (int i = 0; i < data.size(); i++) {
            if (data.get(i).equals(listOfStores)) {
                storesIndex = (i);
            }
        }

        System.out.printf("What is your file called?\n");
        String importedFileName = Marketplace.scanner.nextLine();

        ArrayList<String> imports = new ArrayList<>();
        try {
            FileReader fr = new FileReader(importedFileName);
            BufferedReader br = new BufferedReader(fr);

            boolean add = false;
            while (true) {
                String line = br.readLine();
                if (line == null) {
                    break;
                }
                imports.add(line);

                //data.txt info
                if (line.charAt(0) == 42) {
                    add = true;
                } else if (add) {
                    listOfStores += ", " + line.substring(0, line.indexOf("'"));
                    add = false;
                }
            }
        } catch (Exception e) {
            System.out.printf("Error in import file lol");
        }

        //data.txt updates #2 making the edits
        ArrayList<String> editedData = new ArrayList<>();
        for (int i = 0; i < storesIndex; i++) {
            editedData.add(data.get(i));
        }
        editedData.add(listOfStores);
        editedData.addAll(imports);
        for (int i = (storesIndex + 1); i < data.size(); i++) {
            editedData.add(data.get(i));
        }

        Marketplace.writeData(editedData);
        System.out.printf("%s was successfully imported!\nEverything should be up to date now :)\n\n", importedFileName);
    }
}
